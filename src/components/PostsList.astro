---
// const allPosts = await Astro.glob('../pages/posts/*.md');

import { getCollection } from 'astro:content';

const locale = Astro.currentLocale ?? 'en';

import { getRelativeLocaleUrl } from 'astro:i18n';
import {stripLang} from "../helpers/i18n/stripLang";
import {fixBlogLocale} from "../helpers/i18n/fixBlogLocale";

const allBlogPosts = await getCollection(
    'blog',
    (post) => post.slug.startsWith(locale)
);

import { Picture } from 'astro:assets';
import dayjs from 'dayjs';

import 'dayjs/locale/pl'
import 'dayjs/locale/es'
import * as path from "node:path";

function readingTime(text) {
    const averageWPM = 265;

    const words = text.trim().split(/\s+/);

    const adjustedText = text.replace(/(.)\1+/g, '$1');

    const adjustedSentences = adjustedText.replace(/([.!?])\s*\1+/g, '$1');

    const adjustedCharCount = adjustedSentences.length;

    const adjustedWords = adjustedSentences.trim().split(/\s+/);

    const adjustedWordCount = adjustedWords.length;
    const averageWordLength = adjustedCharCount / adjustedWordCount;

    // return `${words.length} / ${adjustedWords.length} / ${averageWordLength}`;


    const adjustedTime = (adjustedWordCount / averageWPM) * (averageWordLength / 5);

    const formattedAdjustedTime = adjustedTime > 1 ? Math.round(adjustedTime) + " min" : "Less than 1 min";

    return formattedAdjustedTime;
}
---

<pre class="bg-black p-2 text-green-400 w-1/2">{JSON.stringify(allBlogPosts[0], null, 2)}</pre>

<div class="bg-white py-24 sm:py-32">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
        <div class="mx-auto max-w-2xl text-center">
            <h2 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">From the blog</h2>
            <p class="mt-2 text-lg leading-8 text-gray-600">Learn how to grow your business with our expert advice.</p>
        </div>
        <div class="mx-auto mt-16 grid max-w-2xl grid-cols-1 gap-x-8 gap-y-20 lg:mx-0 lg:max-w-none lg:grid-cols-3">
            {allBlogPosts.map(p => (
                    <a href={
                        fixBlogLocale(getRelativeLocaleUrl(locale, 'posts/' + locale + stripLang(p.slug)), locale)
                    }>
                        <article class="flex flex-col items-start justify-between">


                    <div class="relative w-full">
                        <Picture src={p.data.coverImage}
                                 widths={[480, 768]}
                                 formats={['avif']}
                                 alt={p.data.title} inferSize={true}
                                 class="aspect-[16/9] w-full rounded-2xl bg-gray-100 object-cover sm:aspect-[2/1] lg:aspect-[3/2]"
                        ></Picture>
                        <!--<img src="https://images.unsplash.com/photo-1496128858413-b36217c2ce36?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=3603&q=80" alt="" class="aspect-[16/9] w-full rounded-2xl bg-gray-100 object-cover sm:aspect-[2/1] lg:aspect-[3/2]">-->
                        <div class="absolute inset-0 rounded-2xl ring-1 ring-inset ring-gray-900/10"></div>
                    </div>
                    <div class="max-w-xl">
                        <div class="mt-8 flex items-center gap-x-4 text-xs">

                            <!--href="#"-->
                            {p.data.tags.filter((_,i) => i<3).map(tag => <span  class="capitalize relative z-10 rounded-full bg-gray-50 px-3 py-1.5 font-medium text-gray-600 hover:bg-gray-100">{tag}</span>)}
                        </div>
                        <div class="group relative">
                            <h3 class="mt-3 text-lg font-semibold leading-6 text-gray-900 group-hover:text-gray-600">
                                <span>
                                    <!--href="#"-->
                                    <span class="absolute inset-0"></span>
                                    {p.data.title}
                                </span>
                            </h3>
                            <p class="mt-5 line-clamp-3 text-sm leading-6 text-gray-600">
                                {p.data.description}
                            </p>
                        </div>
                        <div class="relative mt-8 flex items-center gap-x-4">
                            <Picture src="https://ucarecdn.com/411d6d7d-6a1e-4096-9a88-fc16a9978f2f/-/preview/688x1000/"
                                     widths={[256]}
                                     formats={['avif']}
                                     alt={p.data.author} inferSize={true}
                                     class="h-10 w-10 rounded-full bg-gray-100  object-cover"
                            ></Picture>
                            <div class="text-sm leading-6">
                                <p class="font-semibold text-gray-900">
                                    <span>
                                        <!--href="#"-->
                                        <span class="absolute inset-0"></span>
                                        {p.data.author}
                                    </span>
                                </p>
                                <p class="text-gray-500">
                                    <time datetime="2020-03-16" class="text-gray-500">{dayjs(p.data.publishDate).locale(locale).format(locale === 'pl' ? 'DD MMM YYYY' : 'MMM DD, YYYY')}</time>
                                    <span class="mx-1 text-gray-400">â€¢</span>
                                    <span>{readingTime(p.body)} read</span></p>
                            </div>
                        </div>
                    </div>

                        </article>

                    </a>

            ))}

            <!-- More posts... -->
        </div>
    </div>
</div>


